name: Automated Content Updates & SEO

on:
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-content:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          npm install
          npx playwright install

      - name: Get Current Date
        id: date
        run: echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Update Game Links
        run: node index-js/${{ matrix.game }}.js

      - name: Generate SEO Content
        run: |
          GAME_NAME=${{ matrix.game }}
          FORMATTED_NAME=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          echo "### 🎮 $FORMATTED_NAME Kostenlose Belohnungen (Aktualisiert: ${{ env.CURRENT_DATE }}) ..." > "_includes/${GAME_NAME}_post.html"
          echo "## 🔍 So löst du $FORMATTED_NAME-Belohnungen ein ..." > "_includes/${GAME_NAME}_footer.html"

      - name: Upload Generated Files
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.game }}-seo
          path: |
            _includes/${{ matrix.game }}_post.html
            _includes/${{ matrix.game }}_footer.html

  deploy:
    runs-on: ubuntu-latest
    needs: generate-content
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensures full history for rebase

      - name: Download All Artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Move Generated Files
        run: |
          find artifacts/ -name '*.html' -exec cp -f {} _includes/ \;

      - name: Deploy Changes
        env: 
          DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git config user.email "prolladmail@gmail.com"
          git config user.name "Auto-Updater"

          # Ensure local branch matches latest origin/main
          git fetch origin main
          git reset --hard origin/main

          # Remove artifacts directory to avoid accidental staging
          rm -rf artifacts/

          # Stage only the intended changes
          git add _includes/

          # Commit only if changes exist
          git diff --cached --quiet || git commit -m "Update all game contents"

          # Pull latest changes and rebase (handles race conditions)
          git pull --rebase origin main

          # Push changes safely
          git push --force-with-lease https://x-access-token:$DEPLOY_KEY@github.com/Prollad99/bs-de.git HEAD:main